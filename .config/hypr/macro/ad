#!/usr/bin/env bash

PIDFILE="/tmp/gv_macro.pid"

# Function to clean up and release keys upon exit
cleanup() {
  echo -e "\nExiting... releasing keys."
  # Ensure all potentially pressed keys are released
  ydotool key 125:0
  ydotool key 30:0
  ydotool key 32:0
  rm -f "$PIDFILE"
  exit 0
}

# Check if script is already running
if [ -e "$PIDFILE" ]; then
  PID=$(cat "$PIDFILE")
  if kill -0 "$PID" >/dev/null 2>&1; then
    echo "Stopping macro (PID $PID)..."
    kill "$PID"
    notify-send -u low -t 2000 "Macro: AD" "Stopped"
    exit 0
  else
    # Stale PID file
    rm -f "$PIDFILE"
  fi
fi

# Write current PID to file
echo $$ >"$PIDFILE"
notify-send -u low -t 2000 "Macro: AD" "Started"

# Trap SIGINT (Ctrl+C) and SIGTERM
trap cleanup SIGINT SIGTERM

echo "Macro running. Press Ctrl+C to stop."

sleep 0.5
ydotool key 125:0

while true; do
  ydotool key 30:1
  ydotool key 30:0

  sleep 10

  ydotool key 32:1
  ydotool key 32:0

  sleep 10
done
