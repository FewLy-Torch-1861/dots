#!/bin/bash

# --------------------------------------------------------------------------
# dots-add: Interactive picker to add untracked files to the repo.
# Uses fd, fzf, and eza for a "beautiful" experience for lazy people.
# --------------------------------------------------------------------------

# Search only in common dotfile locations, feel free to add more if you have more mess.
SEARCH_DIRS=("$HOME/.config" "$HOME/.local/bin")

# Find directories or files that are NOT symlinks
# We ignore .git and common cache dirs to keep the list clean
UNTRACKED=$(fd --hidden --exclude .git --exclude .cache --type d --type f --base-directory "$HOME" . "${SEARCH_DIRS[@]#$HOME/}" | while read -r line; do
  [[ ! -L "$HOME/$line" ]] && echo "$line"
done)

if [[ -z "$UNTRACKED" ]]; then
  echo "Everything is tracked, you've actually done something right for once."
  exit 0
fi

# Use fzf as a picker with a tree preview
SELECTED=$(
  echo "$UNTRACKED" | fzf --header "Select files/directories to track (Tab to multi-select)" \
    --multi --preview "eza --tree --level 2 --icons --color=always $HOME/{}" \
    --preview-window "right:50%:wrap"
)

if [[ -n "$SELECTED" ]]; then
  echo "$SELECTED" | while read -r item; do
    dots-track "$HOME/$item"
  done
else
  echo "Cancelled. Typical indecisiveness."
fi
